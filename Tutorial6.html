<!DOCTYPE html>
<html lang="en" style="height: 0px">
<head>
	<meta charset="utf-8">
	<!-- <meta name="viewport", content="width = device-width, initial-scale = 1"> -->
	<!-- Bootstrap sources -->
	<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
	<!-- Bootstrap -->
	<script src="js/bootstrap.min.js"></script>
	<!-- <link rel="stylesheet" type="text/css" href="css/bootstrap.css"> -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<!-- Jquery -->
	<!-- <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script> -->
	<!-- Joyride CSS file -->
	<!-- <link rel="stylesheet" type="text/css" href="node_modules/jquery.joyride/jquery.joyride.css"> -->
	<!-- Joyride plugin -->
	<!-- <script src="node_modules/jquery.joyride/jquery.joyride.js"></script> -->
	<!-- Font Awesome icons -->
	<script src="https://use.fontawesome.com/releases/v5.0.7/js/all.js"></script>
	<!-- Page icon -->
	<link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
	<!-- Page title (name on the tab) -->
	<title>Pave: the Canadian Job Explorer</title>
	<!-- stylesheet -->
	<link rel="stylesheet" href="css/main.css">
	<!-- Google fonts -->
	<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Raleway">
	<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Montserrat">
</head>


<body style="pointer-events: none">

<div style="position: fixed; margin-top: 1.7%; height: 10vh; margin-left: 2.2%; margin-bottom: 1.5%" class="d-none d-sm-block d-md-block d-lg-block">
	<div class="title" align="left">
		<h1 style="font-size: 3vw; font-weight: bold; color: #49AC52; text-align: left;">
			
			<a id="homepage" href="index.html" style="pointer-events: auto;">
			Pave</a>

      <!-- "Tutorial $current of $total" -->
      <div id="progressTutorial0" class="progressTutorial" style="pointer-events: auto">
        <a id="progTutCircle0" class="progTutCircle progTutCircleActive" href="Tutorial1.html">1</a>
        <a id="progTutCircle1" class="progTutCircle progTutCircleActive" href="Tutorial2.html">2</a>
        <a id="progTutCircle2" class="progTutCircle progTutCircleActive" href="Tutorial3.html">3</a>
        <a id="progTutCircle3" class="progTutCircle progTutCircleActive" href="Tutorial4.html">4</a>
        <a id="progTutCircle4" class="progTutCircle progTutCircleActive" href="Tutorial5.html">5</a>
        <a id="progTutCircle5" class="progTutCircle progTutCircleActive" href="Tutorial6.html">6</a>
        <div id="progTutLine0" class="progTutLine progTutLineActive"></div>
        <div id="progTutLine1" class="progTutLine progTutLineActive"></div>
        <div id="progTutLine2" class="progTutLine progTutLineActive"></div>
        <div id="progTutLine3" class="progTutLine progTutLineActive"></div>
        <div id="progTutLine4" class="progTutLine progTutLineActive"></div>
        <!-- <div id="progTutLine5" class="progTutLine" ></div> -->
      </div>  

		</h1>
	</div>
</div>



<div class="d-inline" style="position: fixed; left: 1vw; top: 15vw; font-size: 1.4vw; font-weight: 600; color: #49AC52">
    <span id='titlespan' style="opacity: 0; font-size: 2.25vw; font-weight: normal;">
      <div id="textBox" style="margin-left: 12vw; width: 35vw">
        <p>The skill sliders let you look at jobs that use different amounts of various skillsets.</p>

        <p>Move the slider handle below to "Lots" to see which jobs use more Math and Spatial skills.</p>
      </div>
<!--       <p style="opacity: 0.5; margin-left: 7vw; margin-bottom: 0em">The circles on the right</p>
      <p style="opacity: 0.5; margin-left: 7vw; margin-bottom: 1.5em">represent job groups.</p>
      <p style="opacity: 0.5; margin-left: 7vw; margin-bottom: 0em">Hover over the circles to see</p>
      <p style="opacity: 0.5; margin-left: 7vw; margin-bottom: 1.5em">the group details.</p>
      <p style="margin-left: 7vw; margin-bottom: 0em">Click the circles on the right to</p>
      <p style="margin-left: 7vw; margin-bottom: 0.25em">see skills used on the job.</p>
 -->    </span>

    <div id="nextDiv" style="position: fixed; left: 21.7vw; top: 50vw;">
        <!-- <a class="intro-tour-button btn-arrow-left" style="display: inline-block; width: 8vw; color: white; z-index: 99;" href="Tutorial1.html" id="prevLink">PREV</a> -->
        <a class="intro-start-button" style="display: inline-block; width: 10vw; opacity: 0; color: white; z-index: 100;" id="nextLink">START</a>
    </div>

</div>

  <svg  id="chart" style="top: 0vw; left: 20vw; pointer-events: visiblePainted; position: fixed; z-index: -1; width: 100vw; height: 100vh; padding-top: 30px" class="chart"> </svg>













<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>

<script>
          d3.selectAll(".progTutCircleActive").on("mouseover",function(){
      d3.select(this).style("background","#3C8D44")
    }).on("mouseout", function(){
      d3.select(this).style("background","#49AC52")
    })

var circles, drag_handler, enterUpdateCircles, graphMode, futureMode, simulation, listToDeleteMulti,
forceCollide, forceXCombine, forceYCombine, forceGravity, forceXSeparate, forceYSeparate, 
forceXSeparateRandom, forceYSeparateRandom, forceCluster, tick, legend, graphYtranslate, currentMode, resetFilters, compressY, width, height, maxWorkers, maxSalary,
hoverTimeout;

maxSalary = 132.922; //busted

var sticky = []; // whether or not the current circle is expanded
var circleExpanded = []; // whether or not the current circle is expanded
var circlesExpanded = 0;
var legendCreated = 0;
var graphFirstTime = true;
var legendMode = 0;
var equalRadius = 9;
var nodePadding = 1;
var imgRadius = 125;
var forceGravityMultiplier = -10;


////////////////////// Hover divs for question marks //////////////////////////////

var sliderArray = [
"skillsLang", "skillsLogi", "skillsMath", "skillsComp",
    // subskills
    "s8OralCommunication","s10Reading","s14Writing",
    
    "s4JobTaskPlanningandOrganizing","s9ProblemSolving","s15CriticalThinking","s2DecisionMaking",
    
    "s5MeasurementandCalculation","s6MoneyMath","s7NumericalEstimation","s11SchedulingorBudgetingandAccounting",
      
    "s1DataAnalysis","s3FindingInformation","s12DigitalTechnology","s13DocumentUse"
];

// var sliderTitlesArray = ["Language skills", "Logic skills", "Math and Spatial skills", "Computer skills",
//   // subskills
//     "Data Analysis","Decision-Making","Finding Information","Job Task Planning and Organizing",
//     "Measurement and Calculation","Money Math","Numerical Estimation","Oral Communication",
//     "Problem Solving","Reading","Scheduling or Budgeting and Accounting","Digital Technology",
//     "Document Use","Writing","Critical Thinking"
//     ];

var sliderTitlesArray = [
// "Language skills", "Logic skills", "Math and Spatial skills", "Computer skills",
  // subskills
    "Oral Communication","Reading","Writing",
    "Job Task Planning and Organizing","Problem Solving","Critical Thinking","Decision-Making",
    "Measurement and Calculation","Money Math","Numerical Estimation","Scheduling or Budgeting and Accounting",
    "Data Analysis","Finding Information","Digital Technology","Document Use"
    ];

var sliderArrayMain = [0,0,"skillsMath",0];

var sliderTitlesArrayMain = [0,0,"Math and Spatial skills",0];

// var sliderArrayStats = ["wage", "workers"];

var sliderArrayLang = ["s8OralCommunication","s10Reading","s14Writing"];
var sliderTitlesArrayLang = ["Oral Communication","Reading","Writing"];

var sliderArrayLogi = ["s2DecisionMaking","s4JobTaskPlanningandOrganizing","s9ProblemSolving","s15CriticalThinking"];
var sliderTitlesArrayLogi = ["Decision-Making","Job Task Planning and Organizing","Problem Solving","Critical Thinking"];

var sliderArrayMath = ["s5MeasurementandCalculation","s6MoneyMath","s7NumericalEstimation","s11SchedulingorBudgetingandAccounting"];
var sliderTitlesArrayMath = ["Measurement and Calculation","Money Math","Numerical Estimation","Scheduling, Budgeting, Accounting"];

var sliderArrayComp = ["s1DataAnalysis","s3FindingInformation","s12DigitalTechnology","s13DocumentUse",];
var sliderTitlesArrayComp = ["Data Analysis","Finding Information","Digital Technology","Document Use"];


var sliderPositionsArray = []; // array to track all sliders
var sliderSVGArray = []; // array of slider SVGs
var sliderScaleArray = []; // array of slider scale functions
var sliderMulti = [];
var handleArray = []; // array of slider handles
listToDeleteMulti = []; // filtered IDs

var filteredIndustries = [];


var graph, store; // displayed, stored data
var clicked = 0; // on: tooltips don't disappear


  // load the data
createViz();

function createViz() {

d3.csv("NOC_494_interpolated.csv", function(error, datapoints) {
  if (error) throw error;



// Viz dimensions & margins
var margin = {top: 20, right: 20, bottom: 50, left: 50};
width = window.innerWidth/1.5, // set chart dimensions
height = window.innerHeight/1.5,
    maxRadius = 30; // Max circle radius


///////////////// TODO: Mobile version /////////////////

d3.select(window).on("resize", function() {
  resize();

  d3.selectAll(".jobCircle").attr("r", equalRadius)

  forceCollide = d3.forceCollide(function(d) { return d.radius + nodePadding })
  forceGravity = d3.forceManyBody().strength(function(d) { return forceGravityMultiplier * d.radius })

  simulation.force("collide", forceCollide).force("gravity", forceGravity)
    .alpha(0.25).alphaTarget(0.001).restart();

});

resize()

function resize() {

  var resizeDuration = 350;

  var w = $(window).width();
  console.log(w)
  var h = $(window).height();
  // console.log(w+" x "+h)

  if(w < 992){
    d3.select("#chart").style("margin-top","-20px")
    d3.select("#titleBar").style("margin-top","-10px").style("margin-left","20px")
    d3.select("#viewButtons").style("margin-top","-20px")
    d3.select("#bottomButtons").style("bottom","7.5vh")
    d3.select("#legend") .style("margin-left","60px")
    d3.selectAll(".btn-legend").style("margin","5px").style("float","right")
    d3.select("#sliderDiv_skillsLang").style("left", "0vw")
    d3.select("#sliderDiv_skillsLogi").style("right", "1.5vw")
    
    nodePadding = 0;
    equalRadius = 6;
    forceGravityMultiplier = -6;

    setTimeout(function() {
      d3.select("#sliderDiv_skillsComp").style("left", "0%")
      d3.select("#sliderDiv_skillsMath").style("right", "1.5%")
    },1)

  }else{
    d3.select("#chart").style("margin-top","")
    d3.select("#titleBar").style("margin-top","-0.35%").style("margin-left","9vw")
    d3.select("#viewButtons") .style("margin-top","10px")
    d3.select("#bottomButtons") .style("bottom","8vh")
    d3.select("#legend") .style("margin-left","40px") .style("float","right")
    d3.selectAll(".btn-legend").style("margin","5px")
    d3.select("#sliderDiv_skillsLang").style("left", "9vw")
    d3.select("#sliderDiv_skillsLogi").style("right", "9vw")
    setTimeout(function() {
      d3.select("#sliderDiv_skillsComp").style("left", "9%")
      d3.select("#sliderDiv_skillsMath").style("right", "9%")
    },1)

    nodePadding = 1;
    equalRadius = 9;
    forceGravityMultiplier = -10;
  }

  if(w < 768){
    d3.select("#sliderDiv_skillsComp").style("bottom", "1vw")
    d3.select("#sliderDiv_skillsMath").style("bottom", "1vw")
    d3.select("#sliderDiv_skillsLang").style("top", "5vh")
    d3.select("#sliderDiv_skillsLogi").style("top", "5vh")
    d3.select("#resetFilters").html("<i class='fa fa-undo-alt'></i>")
       .style("width","85px") .style("margin-bottom","-15px")
    d3.select("#graph").html("<i class='fa fa-chart-bar'></i>")
       .style("width","85px") .style("margin-bottom","-15px")

    nodePadding = 0;
    equalRadius = 5;
    forceGravityMultiplier = -5;

    $("#titleBar").hide()

  }else{
    $("#titleBar").show()
    d3.select("#sliderDiv_skillsComp").style("bottom", "9vw")
    d3.select("#sliderDiv_skillsMath").style("bottom", "9vw")
    d3.select("#sliderDiv_skillsLang").style("top", "9vh")
    d3.select("#sliderDiv_skillsLogi").style("top", "9vh")
    d3.select("#resetFilters").html("<span style='padding-right: 6px;'>" +
      "Reset Filters</span> <i class='fa fa-undo-alt'></i>")
       .style("width","185px") .style("margin-bottom","0px")
    d3.select("#graph").html("<span>Graph View&nbsp&nbsp</span><img width='30px' style='padding-bottom: 3px;' id='graphToggle' src='img/toggle-off.png'></img>"
      ) .style("width","185px") .style("margin-bottom","-15px")

  }


  if(typeof circles != "undefined"){
    circles.attr("transform", circleHeight(0, 0 )) //flag! need to make equation for width/height ratio
  }

  graphYtranslate = window.innerHeight*0.12 - 16;
  // return "translate("+window.innerWidth*0.5+","+ (165 + window.innerHeight*0.12) +")"

  // Add an axis-holder group
  if(typeof axisG != "undefined") {
    axisG.attr("transform", "translate(0," + graphYtranslate + ")");
  }


  if(window.innerWidth<641){ // Phones
    margin = {top: 20, right: 12, bottom: 20, left: 12}
  }
} // end of resize()


// number of distinct clusters
var industries = [];
datapoints.forEach(function(row){
if(!industries.includes(row.industry)) industries.push(row.industry)
}); 
var m = industries.length;


// Actual max workers... need to re-order?
var maxWorkers = 120415; // patch: d3.max(datapoints, function(d) { return d.workers })

// Scales
    // Color scale for 10 categories
// var color = d3.scaleOrdinal(d3.schemeCategory10)
//     .domain(d3.range(m))

var color = d3.scaleOrdinal()
    .domain(d3.range(m))
    .range([
          "#4B40DD",
          "#D42A2F",
          "#329E33",
          "#BCBC35",
          "#2678B2",
          "#AA3DAA",
          "#FD7F27",
          "#7F7F7F",
          "#8B564C",
          "#29BECE",
      ]);

var colorTooltip = d3.scaleOrdinal()
    .domain([0,1,2,3,4,5,6,7,8,9])
    .range(["white", // blue
            "white", // orange
            "white", // green
            "white", // red
            "white", // purple
            "white", // brown
            "white", // pink
            "white", // grey
            "white", // yellow-green
            "white" ]) // teal

var colorTooltip2 = d3.scaleOrdinal()
    .domain([0,1,2,3,4,5,6,7,8,9])
    .range(["#3E35B5", // blue
            "#AE2327", // 
            "#29822A", // green
            "#9A9A2C", // red
            "#206392", // purple
            "#8C328C", // pink
            "#D06820", // orange
            "#686868", // grey
            "#72473F", // brown
            "#229CA9" ]) // teal

var colorSkillbar = d3.scaleOrdinal()
    .domain([0,1,2,3,4,5,6,7,8,9])
    .range(["#256D1B", // purple
            "#256D1B", // red
            "#244F26", // green
            "#256D1B", // red
            "#244F26", // blue
            "#256D1B", // pink
            "#256D1B", // orange
            "#256D1B", // grey
            "#256D1B", // brown
            "#256D1B" ]) // teal

// Scale Circle Area = Number of Workers
// Sqrt scale because radius of a cicrle
var radiusScale = d3.scaleSqrt()
.domain([10, maxWorkers])
.range([1,maxRadius]);


// The largest node for each cluster
var clusters = new Array(m);

// Nodes: the data you want to display & filter by
var nodes = datapoints.map(function(el) {
  var i = el.cluster,
  r = equalRadius, // start equal radii
  d = {
    id: +el.id,
    favourite: 0,
    // transparent: false,
    cluster: i, 
    radius: r, 
    job: el.job,
    allTitles: el.allTitles,
    topSkill1: el.topSkill1,
    topSkill2: el.topSkill2,
    topSkill3: el.topSkill3,
    title1: el.title1,
    title2: el.title2,
    title3: el.title3,
    industry: el.industry, 
    industryNum: el.industryNum, 
    noc: el.noc, 
    workers: +el.workers,
    wage: el.wage,
    salaryMed: el.salaryMed,
    automationRisk: el.automationRisk,
    yearsStudy: el.yearsStudy,
    skillsComp: el.skillsComp,
    skillsLogi: el.skillsLogi,
    skillsMath: el.skillsMath,
    skillsLang: el.skillsLang,
    s1DataAnalysis: el.s1DataAnalysis,
    s2DecisionMaking: el.s2DecisionMaking,
    s3FindingInformation: el.s3FindingInformation,
    s4JobTaskPlanningandOrganizing: el.s4JobTaskPlanningandOrganizing,
    s5MeasurementandCalculation: el.s5MeasurementandCalculation,
    s6MoneyMath: el.s6MoneyMath,
    s7NumericalEstimation: el.s7NumericalEstimation,
    s8OralCommunication: el.s8OralCommunication,
    s9ProblemSolving: el.s9ProblemSolving,
    s10Reading: el.s10Reading,
    s11SchedulingorBudgetingandAccounting: el.s11SchedulingorBudgetingandAccounting,
    s12DigitalTechnology: el.s12DigitalTechnology,
    s13DocumentUse: el.s13DocumentUse,
    s14Writing: el.s14Writing,
    s15CriticalThinking: el.s15CriticalThinking,

};
  // if there's no cluster i OR if biggest radius yet, set cluster
  if (!clusters[i] || (r > clusters[i].radius)) clusters[i] = d;
  return d;
});

// Maximum values
maxWorkers = d3.max(nodes, function(d){ return d.workers});


// Graph mode
    // Toggle for graph mode = off initially
graphMode = 0;
    // store nodes for drawing axes in graph mode
graph = nodes;
store = nodes;


// Simulation, forces, & tick function
    // Forces for the simulation
var forceCollide = d3.forceCollide(function(d) { return d.radius + nodePadding })
var forceXCombine = d3.forceX().strength(.3)
var forceYCombine = d3.forceY().strength(.3)
// default strength = -30, negative strength = repel, positive = attract
var forceGravity = d3.forceManyBody()
.strength(function(d) { return forceGravityMultiplier * d.radius })
// .strength(function(d) { return -7 * automationRadiusScale(d.automationRisk) })
var forceXSeparate = d3.forceX(function(d) {
  return ((width / m) * d.cluster - width/2 - 20) //try window.innerWidth??
}).strength(0.3)
var forceYSeparate = d3.forceY(function(d) {
  return ((height / 2) * d.cluster/40 - 50)
}).strength(0.3)
var forceXSeparateRandom = d3.forceX(function(d) {
  Math.random();
  return ( (width / m) * 10 * Math.random() - width/2 + 0)
}).strength(0.4)
var forceYSeparateRandom = d3.forceY(function(d) {
  return ( Math.random() * (height/2) - 150 )
}).strength(0.3)
// var forceX5By2 = d3.forceX(function(d) { // 10-grid force example
//     if (d.cluster/5<1) return d.cluster/5;
//     if (d.cluster/5>1) return d.cluster/5+1;
// })
    // force the circles toward their cluster nodes

var clusterForce = 3.5;
function forceCluster(alpha) { 
  // alpha = attractor force
  for (var i = 0, n = nodes.length, node, cluster, k = alpha * 0.12; i < n; ++i) {
    node = nodes[i];
    cluster = clusters[node.cluster];
    node.vx -= (clusterForce*node.x - cluster.x) * k;
    node.vy -= (clusterForce*node.y - cluster.y) * k;
  }
  // for (var i = 0, n = nodes.length, node, cluster, k = alpha * 0.1; i < n; ++i) {
  //   node = nodes[i];
  //   cluster = clusters[node.cluster];
  //   node.vx -= (3*node.x - cluster.x) * k;
  //   node.vy -= (3*node.y - cluster.y) * k;
  // }
  }
   
 // Update the positions each tick
tick = function() {

  circles
  .attr("cx", function(d) { 


      // if sticky
      // if(sticky[d.id] == 2){
      //   // stuck
      //   return window.innerWidth*0.4 
      // } else if(sticky[d.id] == 1){
      //   return window.innerWidth*-0.4
      // } else {
      return d.x; 
      // }
  })
  .attr("cy", function(d) { 
    return d.y; });
}


    // The force simulation
simulation = d3.forceSimulation()
.nodes(store)
    // .force("center", d3.forceCenter())
    .force("collide", forceCollide)
    .force("cluster", forceCluster)
    .force("gravity", forceGravity)
    .force("x", forceXCombine)
    .force("y", forceYCombine)
    .on("tick", tick);


// Tooltip div (on hover)
var div = d3.select("body").append("div").style("width", "360px").style("border-radius", "6px").attr("id","tooltip")
var div2;
var miniTooltip;

// Append a group element to the svg & move to center
var svg = d3.select("#chart")
  .append('svg').style("position","absolute").style("z-index", "-1")

var stretch_y = 1.7;
var compress_y = 0.7;
var skillsBarsXtranslate = -15;
var skillsBarsYtranslate = 80;
// TODO: merge pre, post-filtering
///////////////////////// Circles, Tooltips (pre-filtering) /////////////////////////////

function circleHeight(xtrans,ytrans) {
  return "translate("+ (window.innerWidth*0.5 + xtrans)+","+ (window.innerHeight*0.12 + 190 + ytrans) +")"
}

// Add the circles with tooltips
circles = svg.selectAll("circle")
.data(nodes)
.enter().append("circle")
    .attr("r", 0) // start at 0 radius and transition in
    .attr("transform", circleHeight(0,0) ) //flag! need to make equation for width/height ratio
    .attr("id",function(d) { return "circle_"+d.id })
    .attr("class","jobCircle")
    .style("z-index", -1)
    .style("fill", function(d) { return color(d.cluster); })
    // Tooltips
    .on("mouseenter", function(d) {
      if (clicked == 1) return;
      // highlight the current circle
      d3.selectAll("circle").attr("stroke", "none");
      d3.select(this)
        .style("fill", "url(#pattern_"+d.id+")" )
        // .attr("stroke", "black")
        .style("stroke-width", 2)
        .attr("stroke", color(d.cluster));
      showToolTip(0);
      tooltipMouseover(d);
      // hoverTimeout = setTimeout(function(){
      //   tooltipLarge(d)
      //   clicked = 1
      // }, 1750)
      })
    .on("mouseout", function(d) {

      if(!circleExpanded[d.id] == 1){
        d3.select(this)
          .style("fill", color(d.cluster) )
          // .attr("stroke", "black")
          .style("stroke-width", 2)
          .attr("stroke", color(d.cluster));
      }

      // clearTimeout(hoverTimeout)
      if (clicked == 1) return;
      clicked = 0;
      hideToolTip(500)
      d3.select(this).attr("stroke", "none");
      // div.transition().duration(500).style("opacity", 0)

    })
    .on("click", function(d) {
      // clearTimeout(hoverTimeout)
      // click-off
      if (clicked == 1) { 
        clicked = 0
        hideToolTip(500)
      // click-on
      } else if (clicked == 0) {
        clicked = 1;
        tooltipLarge(d);
       }
      // hideToolTip(0);
      // if(typeof div2 != "undefined") div2.transition().duration(250).style("height","0px").remove();
      // tooltipSmall(d);}
      })


d3.select("#chart").on("click", function(d){
  // hide any subskill sliders
  // hideAll();
  // closeLegends();
  // if (graphMode == 0 && legendMode == 1) {
  //   smashTogether(0.3, 0.4);
  // }
  // if clicked off of a circle
  if (clicked == 1) { 
    if (d3.event.target.nodeName == "circle") {
      return
    } else if (d3.event.target.nodeName == "svg") { clicked = 0
    hideToolTip(500) }
  }
})



function showToolTip(duration) {
      d3.select("#tooltip").transition().duration(duration).style("opacity",1)
      d3.select("#tooltip0").transition().duration(duration).style("opacity",1)
      d3.select("#tooltip1").transition().duration(duration).style("opacity",1)
      d3.select("#tooltip2").transition().duration(duration).style("opacity",1)
      d3.select("#tooltip3").transition().duration(duration).style("opacity",1)
      d3.select("#tooltipBottomDiv").transition().duration(duration).style("opacity",1)
      d3.select("#tooltipBottomDiv2").transition().duration(duration).style("opacity",1)

}

function hideToolTip(duration) {

      hideHoverImg();
      // fade out each tooltip contents object
      d3.select("#tooltip").transition().duration(duration).style("opacity",0)
      d3.select("#tooltip0").transition().duration(duration).style("opacity",0).remove()
      d3.select("#tooltip1").transition().duration(duration).style("opacity",0).remove()
      d3.select("#tooltip2").transition().duration(duration).style("opacity",0).remove()
      d3.select("#tooltip3").transition().duration(duration).style("opacity",0).remove()

      // shrink each tooltip div
      // d3.select("#tooltipBottomDiv").transition().duration(duration).style("height","0px").remove()
      // d3.select("#tooltipBottomDiv2").transition().duration(duration).style("height","0px").remove()
      
      d3.select("#tooltipBottomDiv2").transition().duration(duration).style("margin-top","-250px").style("opacity",0).remove()
      d3.select("#tooltipBottomDiv").transition().duration(duration).style("margin-top","-250px").style("opacity",0).remove()
      
      // fade the skill bar rects
      for (var i = 5; i < 9; i++) {
        d3.select("#rect"+i).transition().duration(duration).style("opacity",0).remove()
        d3.select("#rect"+i+"shadow").transition().duration(duration).style("opacity",0).remove()
      }

      // put the original tooltip on top
      d3.select("#moreBtnsContainerDiv").style("z-index","-1")
      d3.select("#moreBtnsDiv").style("z-index","-1")
      
      // shrink the more buttons div
      d3.select("#moreBtnsContainerDiv").transition().duration(300).style("width","20px").style("opacity",0).style("bottom","20px")
      d3.select("#moreBtnsDiv").transition().duration(180).style("opacity",0)
}

var defs = svg.append("defs");


// create for all 494? or create on the fly?

  // defs.append("pattern")

  defs.selectAll(".img-pattern")
    .data(datapoints)
    .enter().append("pattern")
    .attr("class", "img-pattern")
      .attr("id", function(d) { return "pattern_"+d.id} )
      .attr("height", "100%")
      .attr("width", "100%")
      .attr("patternContentUnits", "objectBoundingBox")
      .append("image")
      .attr("height", 1)
      .attr("width", 1)
      .attr("preserveAspectRatio", "none")
      // .attr("xmlns:xlink:href","/img/NOC_images/"+d.noc+".jpg")
      .attr("xlink:href",function(d) {
          return "/img/NOC_images/"+d.noc+".jpg"
        })



function createHoverImg(d) {

  var circLeft, circTop;

  if(d3.event.pageX < window.innerWidth/2) { // left side
    circLeft = window.innerWidth*0.5 + (d.x) - 125; // x
    circTop = window.innerHeight*0.33 + ((window.innerHeight-300)*(d.y/window.innerHeight)); // y

  }else if (d3.event.pageX >= window.innerWidth/2) { // right side
    circLeft = window.innerWidth*0.5 + (d.x) + 125; // x
    circTop = window.innerHeight*0.33 + ((window.innerHeight-300)*(d.y/window.innerHeight)); // y
  }

  var imgCircle = d3.select("#chart").append("circle")
    .attr("class","circleTutorial6")
    .attr("cx",circLeft)
    .attr("cy",circTop)
    .attr("fill", "url(#pattern_"+d.id+")")
  // .append("image").attr("xlink:href","/img/NOC_images/"+d.noc+".jpg")
    // .attr("cy",d3.select(function(){return this.parentNode}).attr("cy"))
    // .attr("r",d3.select(function(d){return d.r}))
      .transition().duration(350)
    .attr("r",imgRadius+"px")
    .style("stroke","black")
    .style("stroke-width","1")
    .style("position","fixed") //bookmark
    .style("z-index","999")
    .style("pointer-events","none")

    // .attr("cx",)
}

function hideHoverImg() {
  d3.selectAll(".circleTutorial6").transition().duration(200).style("opacity",0).remove()
}

function pad(num, size) { // add leading 0s to nocs like 0011
    var s = num+"";
    while (s.length < size) s = "0" + s;
    return s;
}
















var graphMode;

  function tooltipMouseover(d) {
  // create the hover tooltip

      div.append("div").attr("class", "tooltip").attr("id","tooltip0")
      .style("position","absolute").style("z-index","999")
      // .style("left", (d3.event.pageX) + 20 + "px")
      // .style("top", (d3.event.pageY - 80) - d.radius + "px")
      .style("opacity",1).style("width","360px")
       
      div.transition()
      .duration(0)
      .style("box-shadow", "4px 4px 17px #404040FF")
      .style("height", "auto")
      .style("position", "absolute")
      .style("z-index", 999)
      .style("pointer-events","none")

      var divLeft, divTop;
      

        if(d3.event.pageX < window.innerWidth/2) { // left side
          divLeft = window.innerWidth*0.71 + (d.x) + 10;
          divTop = window.innerHeight*0.25 + ((window.innerHeight-300)*(d.y/window.innerHeight));

        } else if (d3.event.pageX >= window.innerWidth/2) { // right side
          divLeft = window.innerWidth*0.69 + (d.x) - 370;
          divTop = window.innerHeight*0.25 + ((window.innerHeight-300)*(d.y/window.innerHeight));
        }

      // pageY increases downward
      // at small pageY, approach d3.event.pageY
      // at large pageY, approach constant window.innerHeight-400

      // Display Hover Tooltip
      div.html("<div id='tooltip1' style='z-index: 999; font-weight: bold; font-size: 20px; padding-top: 7.5px; padding-left: 12.5px; padding-right: 2.5px; font-family: Raleway; color: " + colorTooltip(d.cluster)
        +"; font-weight: bold'>" + d.job + "</div>"
                +"<div id='tooltip2' style='color: " + colorTooltip(d.cluster) +"; padding-left: 10px; font-size: 15px; font-family: Raleway;'>"
        
                +"<svg height='55px' style='margin: 10 0;' class='chart' aria-labelledby='title desc' role='img'>"+
                  "<title id='title'>A bar chart showing information</title>"+
                  "<g class='bar'>"+
                    "<rect width='"+(350*d.salaryMed/maxSalary)+"' style='fill: #256D1B;' height='15'></rect>"+
                    "<text style='fill: " + colorTooltip(d.cluster) +"; font-family: Arial' x='"+(Math.round((350*d.salaryMed/maxSalary+5)*100)/100)+"' y='9.5' dy='.35em'>$ "+Math.round(d.salaryMed*100)/100+"K per yr</text>"+
                  "</g>"+
                  "<g class='bar'>"+
                    "<rect width='"+(150*d.yearsStudy/5)+"' style='fill: #244F26' height='15' y='20'></rect>"+
                    "<text style='fill: " + colorTooltip(d.cluster) +"; font-family: Arial' x='"+(150*d.yearsStudy/5+5)+"' y='28' dy='.35em'>"+Math.round(d.yearsStudy*10)/10+" years of study</text>"+
                  "</g>"+
                  "<g class='bar'>"+
                    "<rect width='"+(150*d.automationRisk)+"' height='15' style='fill: #550C18' y='40'></rect>"+
                    "<text style='fill: " + colorTooltip(d.cluster) +"; font-family: Arial' x='"+(150*d.automationRisk+5)+"' y='48' dy='.35em'>"+(Math.round(d.automationRisk*100))+"% risk of machine automation</text>"+
                  "</g>"+
                "</svg>"                                
                +"Top skills:</br>"
                +"<ul class='subtext' style='margin-top: 5px;'><li>" + d.topSkill1 + "</li><li>" + d.topSkill2 + "</li><li>" + d.topSkill3 + "</ul>"//TOP SKILLS
     +"<div id='tooltip3' style='border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; margin-left: -10px; height: 15px; background: "+ colorTooltip2(d.cluster) +";'>"
                     // Skill minibars
        +"<svg id='miniBars' height='10px' style='position: absolute; margin-top: "+5+"px; margin-left: 25px;' class='chart' aria-labelledby='title desc' role='img'>"+
          "<title id='title'>A bar chart showing information</title>"+
          "<g class='bar'>"+
          // "<text style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-size: 16px; font-family: Raleway' x='-80' y='"+(-7-skillsBarsXtranslate)+"' dy='.35em'>Language</text>"+
          "<rect id='rect1' height='"+(d.skillsLang*compress_y)+"' width='18' style='fill: "+ colorSkillbar(d.cluster) +";' y='"+(skillsBarsYtranslate*0.25-(d.skillsLang*compress_y))+"' x='"+(5-skillsBarsXtranslate)+"'></rect>"+
          // "<text style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-family: Raleway' x='"+(-75)+"' y='"+(15-skillsBarsXtranslate)+"'>"+Math.round(10*d.skillsLang)/10+"</text>"+
          "</g>"+
          "<g class='bar'>"+
          // "<text style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-size: 16px; font-family: Raleway' x='-80' y='"+(30-skillsBarsXtranslate)+"' dy='.35em'>Logic</text>"+
          "<rect id='rect2' height='"+(d.skillsLogi*compress_y)+"' width='18' style='fill: "+ colorSkillbar(d.cluster) +";' y='"+(skillsBarsYtranslate*0.25-(d.skillsLogi*compress_y))+"' x='"+(40-skillsBarsXtranslate)+"'></rect>"+
          // "<text style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-family: Raleway' x='"+(-75)+"' y='"+(50-skillsBarsXtranslate)+"'>"+Math.round(10*d.skillsLogi)/10+"</text>"+
          "</g>"+
          "<g class='bar'>"+
          // "<text style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-size: 16px; font-family: Raleway' x='-80' y='"+(100-skillsBarsXtranslate)+"' dy='.35em'>Computer</text>"+
          "<rect id='rect4' height='"+(d.skillsComp*compress_y)+"' width='18' style='fill: "+ colorSkillbar(d.cluster) +";' y='"+(skillsBarsYtranslate*0.25-(d.skillsComp*compress_y))+"' x='"+(75-skillsBarsXtranslate)+"'></rect>"+
          // "<text style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-family: Raleway' x='"+(-75)+"' y='"+(120-skillsBarsXtranslate)+"'>"+Math.round(10*d.skillsComp)/10+"</text>"+
          "</g>"+
          "<g class='bar'>"+
          // "<text style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-size: 16px; font-family: Raleway' x='-80' y='"+(65-skillsBarsXtranslate)+"' dy='.35em'>Math</text>"+
          "<rect id='rect3' height='"+(d.skillsMath*compress_y)+"' width='18' style='fill: "+ colorSkillbar(d.cluster) +";' y='"+(skillsBarsYtranslate*0.25-(d.skillsMath*compress_y))+"' x='"+(110-skillsBarsXtranslate)+"'></rect>"+
          // "<text style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-family: Raleway' x='"+(-75)+"' y='"+(85-skillsBarsXtranslate)+"'>"+Math.round(10*d.skillsMath)/10+"</text>"+
          "</g>"+
        "</svg>"
        // +"<span id='clickSpan' style='position: absolute; right: 45px; bottom: -3px; color: white; font-size: 14px;'>&#9660&nbspclick&nbsp&#9660</span>"
        +"</div>")
        // Move div above mouse by "top" + radius and right by "left"
        .style("left", divLeft + "px")
        .style("background", color(d.cluster) )
        .style("top", (divTop) + "px")
        .style("z-index",999);

      createHoverImg(d);

  }

  function tooltipLarge(d) {

  div2 = div.append("div")
  .attr("id","tooltipBottomDiv").style("background",colorTooltip2(d.cluster))
  .style("height","0px").style("width","360px")
  .style("z-index",-1)
  .style("border-bottom-left-radius","6px")
  .style("border-bottom-right-radius","6px")
  .style("pointer-events","auto");

  d3.select("#miniBars").transition().duration(275)
  // .style("margin-top",250+"px")
  .style("opacity",0);
 
  var maxLength = 34
  //Some job titles from this group are...
  if(d.title1.length>maxLength){var title1 = d.title1.substring(0,maxLength) + "..."
  }else{var title1 = d.title1}
  if(d.title2.length>maxLength){var title2 = d.title2.substring(0,maxLength) + "..."
  }else{var title2 = d.title2}
  if(d.title3.length>maxLength){var title3 = d.title3.substring(0,maxLength) + "..."
  }else{var title3 = d.title3}

  setTimeout(function(){

    d3.select("#tooltipBottomDiv")
    .html("<div id='tooltipBottomDiv2' style=' z-index: -1; margin-top: -15px; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; font-size: 16px; padding-top: 5px; padding-left: 10px; font-family: Raleway; color: " + colorTooltip(d.cluster)
      +"; background: "+ colorTooltip2(d.cluster) +";'>"

        +"<span style='padding-left: 3px;'>Some job titles from this group are:</span></br>"
        +"<ul style='padding-top: 9px;'><li>"+title1+"</li><li>"+title2+"</li><li>"+title3+"</li></ul></div>"

      // Skill levels
        +"<svg height='80px' style='position: absolute; margin-top: "+(15)+"px; margin-left: 15px;' class='chart' aria-labelledby='title desc' role='img'>"+
        "<title id='title'>A bar chart showing information</title>"+

        "<g class='bar'>"+                                                                       // y = x if rotated 90deg
        "<rect id='rect5shadow' class='shadow' height='"+(d.skillsLang*stretch_y)+"' width='18' transform='translate(3,7)' style='box-shadow: 3px 3px 3px black; fill: #30352F;' y='"+(skillsBarsYtranslate-(d.skillsLang*stretch_y))+"' x='"+(5-skillsBarsXtranslate)+"'></rect>"+
        "<rect id='rect5' height='"+(d.skillsLang*stretch_y)+"' width='18' style='box-shadow: 3px 3px 3px black; fill: #256D1B;' y='"+(skillsBarsYtranslate-(d.skillsLang*stretch_y))+"' x='"+(5-skillsBarsXtranslate)+"'></rect>"+
        "<text class='subtext' style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-size: 16px; font-family: Raleway' x='-80' y='"+(-5-skillsBarsXtranslate)+"' dy='.35em'>"+
          "Language</text>"+
        // "<text class='subtext' style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-family: Raleway' x='"+(-75)+"' y='"+(17-skillsBarsXtranslate)+"'>"+
        //   Math.round(10*d.skillsLang)/10+"</text>"+
        "</g>"+
        "<g class='bar'>"+
        "<rect id='rect6shadow' class='shadow' height='"+(d.skillsLogi*stretch_y)+"' width='18' transform='translate(3,7)' style='box-shadow: 3px 3px 3px black; fill: #30352F;' y='"+(skillsBarsYtranslate-(d.skillsLogi*stretch_y))+"' x='"+(40-skillsBarsXtranslate)+"'></rect>"+
        "<rect id='rect6' height='"+(d.skillsLogi*stretch_y)+"' width='18' style='box-shadow: 3px 3px 3px black; fill: #256D1B;' y='"+(skillsBarsYtranslate-(d.skillsLogi*stretch_y))+"' x='"+(40-skillsBarsXtranslate)+"'></rect>"+
        "<text class='subtext' style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-size: 16px; font-family: Raleway' x='-80' y='"+(32-skillsBarsXtranslate)+"' dy='.35em'>"+
        "Logic</text>"+
        // "<text class='subtext' style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-family: Raleway' x='"+(-75)+"' y='"+(52-skillsBarsXtranslate)+"'>"+
        //   Math.round(10*d.skillsLogi)/10+"</text>"+
        "</g>"+
        "<g class='bar'>"+
        "<rect id='rect7shadow' class='shadow' height='"+(d.skillsComp*stretch_y)+"' width='18' transform='translate(3,7)' style='box-shadow: 3px 3px 3px black; fill: #30352F;' y='"+(skillsBarsYtranslate-(d.skillsComp*stretch_y))+"' x='"+(75-skillsBarsXtranslate)+"'></rect>"+
        "<rect id='rect7' height='"+(d.skillsComp*stretch_y)+"' width='18' style='box-shadow: 3px 3px 3px black; fill: #256D1B;' y='"+(skillsBarsYtranslate-(d.skillsComp*stretch_y))+"' x='"+(75-skillsBarsXtranslate)+"'></rect>"+
        "<text class='subtext' style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-size: 16px; font-family: Raleway' x='-80' y='"+(67-skillsBarsXtranslate)+"' dy='.35em'>Computer</text>"+
        // "<text class='subtext' style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-family: Raleway' x='"+(-75)+"' y='"+(87-skillsBarsXtranslate)+"'>"+Math.round(10*d.skillsComp)/10+"</text>"+
        "</g>"+
        "<g class='bar'>"+
        "<rect id='rect8shadow' class='shadow' height='"+(d.skillsMath*stretch_y)+"' width='18' transform='translate(3,7)' style='box-shadow: 3px 3px 3px black; fill: #30352F;' y='"+(skillsBarsYtranslate-(d.skillsMath*stretch_y))+"' x='"+(110-skillsBarsXtranslate)+"'></rect>"+
        "<rect id='rect8' height='"+(d.skillsMath*stretch_y)+"' width='18' style='box-shadow: 3px 3px 3px black; fill: #256D1B;' y='"+(skillsBarsYtranslate-(d.skillsMath*stretch_y))+"' x='"+(110-skillsBarsXtranslate)+"'></rect>"+
        "<text class='subtext' style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-size: 16px; font-family: Raleway' x='-80' y='"+(102-skillsBarsXtranslate)+"' dy='.35em'>Math</text>"+
        // "<text class='subtext' style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-family: Raleway' x='"+(-75)+"' y='"+(122-skillsBarsXtranslate)+"'>"+Math.round(10*d.skillsMath)/10+"</text>"+
        "</g>"+
        "</svg>"+
        // +"<br/>" 
        "<span style='margin-left: 231px'></span>"+
        "<span style='margin-top: 10px; margin-left: 220px'></span>"+
        "<button id='viewMoreBtn' class='btn btn-lg'"+
        "style='position: absolute; right: 17px; bottom: 20px; z-index: 999; box-shadow: 3px 3px 3px grey; font-size: 16px; font-weight: bold; margin-top: 11px; font-family: Raleway; background: white; color: " + color(d.cluster) +"'>"+
        "View more</button>"+"</div>")

    d3.select("#viewMoreBtn").on("click", function() {
        d3.select("#viewMoreBtn").transition().duration(500).style("opacity",0).remove()

        // d3.select("#tooltipBottomDiv").style("border-radius", "6px")
        // .transition().duration(500).style("width","550px")
        // .style("box-shadow","7px 7px 17px #404040FF")
        
        div3 = d3.select("#tooltipBottomDiv").append("div").attr("id","moreBtnsContainerDiv")
          .style("height","250px")
          .style("box-shadow","6px 4px 12px #404040FF")
          .style("border-top-right-radius","6px")
          .style("border-bottom-right-radius","6px")
          .style("background", colorTooltip2(d.cluster))
          .style("position","absolute")
          .style("left","160px")
          .style("bottom","0px")
          .style("z-index","-1")
          .html("<div id='moreBtnsDiv' align='right' style='margin-top: 0px; margin-left: 15px; margin-right: 15px;'>"+

        "<a id='btnJobBank' class='btn btn-sm' href='"+"http://noc.esdc.gc.ca/English/NOC/QuickSearch.aspx?ver=&val65="+pad(d.noc,4)+"' target='_blank' "+
        "style='margin-top: 20px; margin-bottom: 10px; box-shadow: 3px 3px 3px grey; font-size: 16px; font-weight: bold; font-family: Raleway; background: white; color: " + color(d.cluster) + "'>"+
        "JobBank page</a><br>"+

        "<button id='btnSimilarSkills' class='btn btn-sm' "+
        "style='margin-top: 20px; margin-bottom: 10px; box-shadow: 3px 3px 3px grey; font-size: 16px; font-weight: bold; font-family: Raleway; background: white; color: " + color(d.cluster) + "'>"+
        "Similar jobs <br><span style='font-size: 12px'>(sets filters equal to <br>this group's skill levels)</span></button><br>"+

        "<br><br><span style='margin-left: -20px; color: white;'>"+
        "This section is currently under construction...</span>"+

        "<div align='right' style='margin: 10px 0px 20px 0px'>"+
        "<a id='btnIndeed' class='btn btn-sm' "+
        "style='border-radius: 4px; margin-bottom: 10px; box-shadow: 3px 3px 3px grey; font-size: 16px; font-weight: bold; font-family: Raleway; background: white; color: " + color(d.cluster) +
        "'>"+
        "&nbspcoming soon&nbsp</a><br>"+
        "</div></div>")
          
        d3.select("#btnSimilarSkills").on("click", function() {
          // set filter levels to this job group's levels
        })

        div3.transition().duration(350).style("left","360px").style("height","360px")

        d3.select("#moreBtnsDiv").style("opacity",0).transition().duration(350).style("opacity",1).style("left","360px")
    })

   }, 275);

  // skill bars
  d3.select("#tooltipBottomDiv").append("svg")
  .attr("height","280px").style("position","absolute").style("margin-left","25px")
  .append("rect").attr("height",(d.skillsLang*compress_y)).attr("width","18")
  .style("fill",colorSkillbar(d.cluster))
  .attr("y",(skillsBarsYtranslate*0.25-(d.skillsLang*compress_y))).attr("x",(5-skillsBarsXtranslate))
  .transition().duration(275)
    .attr("height", (d.skillsLang*stretch_y))
    .attr("y",150)

  d3.select("#tooltipBottomDiv").append("svg")
  .attr("height","280px").style("position","absolute").style("margin-left","25px")
  .append("rect").attr("height",(d.skillsLogi*compress_y)).attr("width","18")
  .style("fill",colorSkillbar(d.cluster))
  .attr("y",(skillsBarsYtranslate*0.25-(d.skillsLogi*compress_y))).attr("x",(40-skillsBarsXtranslate))
  .transition().duration(275)
    .attr("height", (d.skillsLogi*stretch_y))
    .attr("y",150)  

  d3.select("#tooltipBottomDiv").append("svg")
  .attr("height","280px").style("position","absolute").style("margin-left","25px")
  .append("rect").attr("height",(d.skillsComp*compress_y)).attr("width","18")
  .style("fill",colorSkillbar(d.cluster))
  .attr("y",(skillsBarsYtranslate*0.25-(d.skillsComp*compress_y))).attr("x",(75-skillsBarsXtranslate))
  .transition().duration(275)
    .attr("height", (d.skillsComp*stretch_y))
    .attr("y",150)  

  d3.select("#tooltipBottomDiv").append("svg")
  .attr("height","280px").style("position","absolute").style("margin-left","25px")
  .append("rect").attr("height",(d.skillsMath*compress_y)).attr("width","18")
  .style("fill",colorSkillbar(d.cluster))
  .attr("y",(skillsBarsYtranslate*0.25-(d.skillsMath*compress_y))).attr("x",(110-skillsBarsXtranslate))
  .transition().duration(275)
    .attr("height", (d.skillsMath*stretch_y))
    .attr("y",150)

  div2.transition().duration(250).style("height","250px");

     };

function tooltipSmall(d) {
  d3.selectAll(".subtext").style("opacity",0)
  d3.select("#tooltipBottomDiv2").transition().duration(250).style("height","0px");
  d3.select("#tooltipBottomDiv").transition().duration(250).style("height","0px");
  d3.select("#tooltipContent").transition().duration(250).style("height", "100px");
      setTimeout(function() {
              div.html("<div style='z-index: 99; font-weight: bold; font-size: 20px; padding-top: 7.5px; padding-left: 12.5px; font-family: Raleway; color: " + colorTooltip(d.cluster)
        +"; font-weight: bold'>" + d.job + "</div>"
                +"<div id='tooltip2' style='color: " + colorTooltip(d.cluster) +"; padding-left: 10px; font-size: 15px; font-family: Raleway;'>"
        
                +"<svg height='55px' style='margin: 10 0;' class='chart' aria-labelledby='title desc' role='img'>"+
                  "<title id='title'>A bar chart showing information</title>"+
                  "<g class='bar'>"+
                    "<rect width='"+(350*d.salaryMed/maxSalary)+"'  style='fill: #256D1B;'height='15' ></rect>"+
                    "<text style='fill: " + colorTooltip(d.cluster) +"; font-family: Raleway' x='"+(Math.round((350*d.salaryMed/maxSalary+5)*100)/100)+"' y='9.5' dy='.35em'>$ "+Math.round(d.salaryMed*100)/100+"K per yr</text>"+
                  "</g>"+
                  "<g class='bar'>"+
                    "<rect width='"+(150*d.yearsStudy/5)+"' style='fill: #244F26' height='15' y='20'></rect>"+
                    "<text style='fill: " + colorTooltip(d.cluster) +"; font-family: Raleway' x='"+(150*d.yearsStudy/5+5)+"' y='28' dy='.35em'>"+Math.round(d.yearsStudy*10)/10+" years of study</text>"+
                  "</g>"+
                  "<g class='bar'>"+
                    "<rect width='"+(150*d.automationRisk)+"' height='15' style='fill: #550C18' y='40'></rect>"+
                    "<text style='fill: " + colorTooltip(d.cluster) +"; font-family: Raleway' x='"+(150*d.automationRisk+5)+"' y='48' dy='.35em'>"+(Math.round(d.automationRisk*100))+"% risk of machine automation</text>"+
                  "</g>"+
                "</svg>"             
                +"Top skills:</br>"
                +"<ul class='subtext' style='margin-top: 5px;'><li>" + d.topSkill1 + "</li><li>" + d.topSkill2 + "</li><li>" + d.topSkill3 + "</ul>"//TOP SKILLS
                     
     +"<div style='border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; height: 15px; background: "+ colorTooltip2(d.cluster) +";'>"
                     // Skill minibars
        +"<svg id='miniBars' height='10px' style='position: absolute; margin-top: "+5+"px; margin-left: 25px;' class='chart' aria-labelledby='title desc' role='img'>"+
          "<title id='title'>A bar chart showing information</title>"+
          "<g class='bar'>"+
          // "<text style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-size: 16px; font-family: Raleway' x='-80' y='"+(-7-skillsBarsXtranslate)+"' dy='.35em'>Language</text>"+
          "<rect id='rect1' height='"+(d.skillsLang*compress_y)+"' width='18' style='fill: "+ colorSkillbar(d.cluster) +";' y='"+(skillsBarsYtranslate*0.25-(d.skillsLang*compress_y))+"' x='"+(5-skillsBarsXtranslate)+"'></rect>"+
          // "<text style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-family: Raleway' x='"+(-75)+"' y='"+(15-skillsBarsXtranslate)+"'>"+Math.round(10*d.skillsLang)/10+"</text>"+
          "</g>"+
          "<g class='bar'>"+
          // "<text style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-size: 16px; font-family: Raleway' x='-80' y='"+(30-skillsBarsXtranslate)+"' dy='.35em'>Logic</text>"+
          "<rect id='rect2' height='"+(d.skillsLogi*compress_y)+"' width='18' style='fill: "+ colorSkillbar(d.cluster) +";' y='"+(skillsBarsYtranslate*0.25-(d.skillsLogi*compress_y))+"' x='"+(40-skillsBarsXtranslate)+"'></rect>"+
          // "<text style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-family: Raleway' x='"+(-75)+"' y='"+(50-skillsBarsXtranslate)+"'>"+Math.round(10*d.skillsLogi)/10+"</text>"+
          "</g>"+
          "<g class='bar'>"+
          // "<text style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-size: 16px; font-family: Raleway' x='-80' y='"+(100-skillsBarsXtranslate)+"' dy='.35em'>Computer</text>"+
          "<rect id='rect3' height='"+(d.skillsComp*compress_y)+"' width='18' style='fill: #256D1B;' y='"+(skillsBarsYtranslate*0.25-(d.skillsComp*compress_y))+"' x='"+(75-skillsBarsXtranslate)+"'></rect>"+
          // "<text style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-family: Raleway' x='"+(-75)+"' y='"+(120-skillsBarsXtranslate)+"'>"+Math.round(10*d.skillsComp)/10+"</text>"+
          "</g>"+
          "<g class='bar'>"+
          // "<text style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-size: 16px; font-family: Raleway' x='-80' y='"+(65-skillsBarsXtranslate)+"' dy='.35em'>Math</text>"+
          "<rect id='rect4' height='"+(d.skillsMath*compress_y)+"' width='18' style='fill: #256D1B;' y='"+(skillsBarsYtranslate*0.25-(d.skillsMath*compress_y))+"' x='"+(110-skillsBarsXtranslate)+"'></rect>"+
          // "<text style='fill: " + colorTooltip(d.cluster) +"; transform: rotate(-90deg); font-family: Raleway' x='"+(-75)+"' y='"+(85-skillsBarsXtranslate)+"'>"+Math.round(10*d.skillsMath)/10+"</text>"+
          "</g>"+
        "</svg>"
        +"</div>")

            }, 200);

  d3.select("#rect5")
  .transition().duration(200)
    .attr("height", (d.skillsLang*compress_y))
    .attr("y",-100)  

  d3.select("#rect6")
  .transition().duration(200)
    .attr("height", (d.skillsLogi*compress_y))
    .attr("y",-100)  

  d3.select("#rect7")
  .transition().duration(200)
    .attr("height", (d.skillsComp*compress_y))
    .attr("y",-100)  

  d3.select("#rect8")
  .transition().duration(200)
    .attr("height", (d.skillsMath*compress_y))
    .attr("y",-100)

  d3.select("#rect5shadow")
  .transition().duration(150)
    .attr("height", (d.skillsLang*compress_y))
    .attr("y",-100)  

  d3.select("#rect6shadow")
  .transition().duration(150)
    .attr("height", (d.skillsLogi*compress_y))
    .attr("y",-100)  

  d3.select("#rect7shadow")
  .transition().duration(150)
    .attr("height", (d.skillsComp*compress_y))
    .attr("y",-100)  

  d3.select("#rect8shadow")
  .transition().duration(150)
    .attr("height", (d.skillsMath*compress_y))
    .attr("y",-100)
}

// on start, transition in radii from 0
circles.transition()
.duration(2000)
.delay(function(d, i) { return i * 4})
.attrTween("r", function(d) {
  var i = d3.interpolate(0, d.radius);
  return function(t) { return d.radius = i(t); };
})
.styleTween("opacity", function() {
  var i = d3.interpolate(0, 1);
  return function(t) { return i(t) }
});


// // Enable dragging
// function dragstarted(d) { // no dragging in graph mode

//   // if clicking on the chart, restart the simulation
//   if (!d3.event.active && graphMode == 0) simulation.alphaTarget(0.001).restart();    

//     d.fx = d.x; // drag
//     d.fy = d.y;

//   // if dragged to right side, becomes sticky
//   // if (d.fx < window.innerWidth*0.8){
//     // sticky[d.id] = 1
//   // }

// }

// function dragged(d) {
//   d3.select(this).classed("fixed", d.fixed = true);


//   // if in right sticky zone
//   if(d.x > window.innerWidth*0.4) { 
//     // stick!
//     sticky[d.id] = 2 // right side
//     d3.select(this).style("fill", function(d) { return "url(#pattern_"+d.id+")" }).attr("stroke-width", "2px").attr("r","30px")
//   // if in left sticky zone
//   } else if (d.x < window.innerWidth*-0.4){
//     sticky[d.id] = 1 // left side
//     d3.select(this).style("fill", function(d) { return "url(#pattern_"+d.id+")" }).attr("stroke-width", "2px").attr("r","30px")
//   }

//   d.fx = d3.event.x;
//   d.fy = d3.event.y;
// }

// function dragended(d) {
//   if (!d3.event.active && graphMode == 0) simulation.alphaTarget(0.001);
//   d.fx = null;
//   d.fy = null;
// } 

// drag_handler = d3.drag()
// .on("start", dragstarted)
// .on("drag", dragged)
// .on("end", dragended);

// drag_handler(circles);



///////////// Reset Filters /////////////

d3.select("#resetFilters").on('click', function(d) {
  // if (graphMode == 1) {
  //   graphMode = 0;

  //   graphModeOff();
  // }c
  resetFilters(currentMode);
});

resetFilters = function(mode) {
//collapseCircleImages()
  if(circlesExpanded == 1){
    circlesExpanded = 0;

    circles.transition().duration(350)
    // .delay(function(d, i) { return i * 5})
    .attrTween("r", function(d) {
      var i = d3.interpolate(40, 10);
      return function(t) { return d.radius = i(t); };
    }) 

    if(graphMode == 0) {
      setTimeout(function() { 
          
          forceGravity = d3.forceManyBody().strength(function(d) { return forceGravityMultiplier * d.radius });

          simulation
          .force("cluster", forceCluster)
          // .force("gravity", forceGravity)
          .force("x", forceXCombine)
          .force("y", forceYCombine)
          .on("tick", tick)
          .force("gravity", // default strength = -30, negative strength = repel, positive = attract
                  forceGravity)
          // .force()
          .force("collide", d3.forceCollide(function(d) { return d.radius + nodePadding }))

          simulation.alpha(0.6).alphaTarget(0.001).restart(); 

      }, 450);
    }
  }//end collapseCircleImages
  // Reset green inset-left on all sliders
  // Main sliders
  for(var i=0; i<sliderArray.length; i++) {

      d3.select("#inset-left_"+i).transition().duration(500).attr("x2", 0 )

  };

  // reset the graph
  graph = store;
  hideAll();
  hideGraphViewCallout();
  // reset the slider positions
  for(var i=0; i<sliderArray.length; i++) {
    handleArray[i].transition().duration(500).attr("cx", sliderScaleArray[i](0)); // move the slider handle
    sliderPositionsArray[i] = 0; // Update the slider positions array
  };

  // reset all circles
  circles = circles.data(store, function(d) { return d.id });
  // ENTER (create the circles with all attributes)
  enterUpdateCircles();
  // restart simulation only if graph mode off
  // if (graphMode == 0) {
      resetSimulation();
    // }
  }

  function resetSimulation() {
    simulation.nodes(store)
    .force("collide", forceCollide)
    .force("cluster", forceCluster)
    .force("gravity", forceGravity)
    .force("x", forceXCombine)
    .force("y", forceYCombine)
    .on("tick", tick);

    restartSimulation();
  }

  function restartSimulation(){
    simulation.alpha(0.25).alphaTarget(0.001).restart();
  }



/////// Tooltips (post-filter)

enterUpdateCircles = function() {
    var newCircles = circles.enter().append("circle")
    .attr("r", function(d) { return d.radius }) // start at full radius
    .attr("transform", "translate("+window.innerWidth*0.5+","+ (120 + window.innerHeight*0.2) +")") //flag! need to make equation for width/height ratio
    .style("fill", function(d) { 
      if(circleExpanded[d.id] != 1){
        return color(d.cluster); 
      }else { return "url(#pattern_"+d.id+")" }
     })
    .attr("class","jobCircle")
    .attr("id",function(d) { return "circle_"+d.id })
    .attr("opacity",
      function(d) { // make filtered circles transparent
        // if the industry is on the list, transparent
        if( filteredIndustries.includes(+d.industryNum) ) { 
          return 0.1 }
        else{ 
          return 1 }
    })  
    // newCircles.attr("r",0).transition().duration(500).attr("r", function(d) { return d.radius })
    // Tooltips
    .on("mouseenter", function(d) {
      if (clicked == 1) return;
      // highlight the current circle
      d3.selectAll("circle").attr("stroke", "none");
      d3.select(this)
        .style("fill", "url(#pattern_"+d.id+")" )
        // .attr("stroke", "black")
        .style("stroke-width", 2)
        .attr("stroke", color(d.cluster));
      showToolTip(0);
      tooltipMouseover(d);
      hoverTimeout = setTimeout(function(){
        tooltipLarge(d)
        clicked = 1
      }, 1750)
      })
    .on("mouseout", function(d) {

      if(!circleExpanded[d.id] == 1){
        d3.select(this)
          .style("fill", color(d.cluster) )
          // .attr("stroke", "black")
          .style("stroke-width", 2)
          .attr("stroke", color(d.cluster));
      }

      clearTimeout(hoverTimeout)
      if (clicked == 1) return;
      clicked = 0;
      hideToolTip(500)
      d3.select(this).attr("stroke", "none");
      // div.transition().duration(500).style("opacity", 0)

    })
    .on("click", function(d) {
      clearTimeout(hoverTimeout)
      // click-off
      if (clicked == 1) { 
        clicked = 0
        hideToolTip(500)
      // click-on
      } else if (clicked == 0) {
        clicked = 1;
        tooltipLarge(d);
       }
      // hideToolTip(0);
      // if(typeof div2 != "undefined") div2.transition().duration(250).style("height","0px").remove();
      // tooltipSmall(d);}
      })

  // drag_handler(newCircles);
  //  ENTER + UPDATE
  // if(graphMode == 1){ // transition in radii in graph mode
  //   circles = circles.merge(newCircles.attr("r",0).transition().duration(500).attr("r", function(d) { return d.radius }));
  // }else if(graphMode == 0){
    circles = circles.merge(newCircles);
  // }
  
}














///////////////////////////////// Filters ////////////////////////////////////
var sliderSideTranslate = 9;
if(window.innerWidth >= 1007) {
  sliderSideTranslate = window.innerWidth*0.01
  d3.select("#titleBar").style("margin-left", window.innerWidth*0.01 + "vw")
  d3.select(".search-div").style("right", window.innerWidth*0.0094 + "vw")
}
var sliderHeightTranslate = 9;
// d3.select("#titleBar").style("margin-left","14vw")
//////////////// Filter Sliders 2: Multiple Sliders from an Array //////////////////////

createSliders(sliderArrayMain, sliderTitlesArrayMain);

// createSliders(sliderArrayLang, sliderTitlesArrayLang);

function createSliders(createSliderArray, sliderTitlesArray){
// For Each Slider create the slider
  for(var i=0; i<createSliderArray.length; i++) {
    if(i==2){

    
    var sub_xtranslate = 3,
        xtrans,
        ytrans;
    var leftOrRight, topOrBottom;

  // Top row
  if(["Language skills", "Logic skills"].includes(sliderTitlesArray[i])){
    xtrans = sliderSideTranslate;
    ytrans = sliderHeightTranslate;
    topOrBottom = "top";
  }
  // Right column
  if(["Math and Spatial skills", "Logic skills"].includes(sliderTitlesArray[i])){
    // xtrans = sliderSideTranslate;
    leftOrRight = "right";
    // posn = "fixed";
  }
   // Bottom row
  if(["Math and Spatial skills", "Computer skills"].includes(sliderTitlesArray[i])){
    xtrans = sliderSideTranslate;
    ytrans = sliderHeightTranslate;
    topOrBottom = "bottom";
  }
  // Left column
  if(["Language skills", "Computer skills"].includes(sliderTitlesArray[i])){
    leftOrRight = "left";
  }

  // Title & SVG
  var sliderButtonArrows = ["&#9660", "&#9660", "&#9650", "&#9650"];
  var sliderButtonPositions = [];

  sliderSVGArray[i] = d3.select("body")
  .append("div").style("display","inline").style("width","30vw")
    .attr("id", "sliderDiv_"+sliderArrayMain[i]) // sliderDiv_skillsLang
    .style("position", "fixed")
    .style("left", "11vw")
    .style("top", "35vw")
    // lg and xl
    .html("<div class='d-none d-sm-none d-md-none d-lg-inline d-xl-inline' align='left' style='margin-left: 2vw;"
      +"font-size: 150%; font-weight: bold;"
      +" color:  #49AC52; font-family: Raleway'>"
      +sliderTitlesArray[i] // "Language skills"
      +"<img id=question_"+i+" class='img-question d-none d-sm-inline d-md-inline d-lg-inline d-xl-inline' src='img/question.png' "
      +"alt='help' height='21' width = '24'>"
      +"</div>"
    // md sm and xs
  +"<div class='d-inline d-sm-inline d-md-inline d-lg-none d-xl-none' align='left' style='margin-left: "+(sub_xtranslate)+"%;"
      +"font-size: 15vw; font-weight: bold;"
      +" color:  #49AC52; font-family: Raleway'>"
      +sliderTitlesArray[i] // "Language skills"
      +"<img class='d-none d-sm-inline d-md-inline d-lg-inline d-xl-inline' style='padding-left: 5px; padding-bottom: 2px;' src='img/question.png' "
      +"alt='help' height='21' width = '24'>"
      +"</div>"
    // sm and xs
  // +"<div class='d-inline d-sm-inline d-md-none d-lg-none d-xl-none' align='left' style='margin-left: "+(sub_xtranslate)+"%;"
  //     +"font-size: 100%; font-weight: bold;"
  //     +" color:  #49AC52; font-family: Raleway'>"
  //     +sliderTitlesArray[i].substring(0,sliderTitlesArray[i].length - 7) // "Language skills"
  //     +"<img style='padding-left: 5px; padding-bottom: 2px;' src='img/question.png' "
  //     +"alt='help' height='21' width = '24'>"
  //     +"</div>"
      )

  // Not Much       Lots
  .append("div")
    .attr("align", "left")
    .style("position", "relative")
    .style("margin-top", "40px")
    .style("margin-left", "1.5vw")
    .style("color", "#49AC52")
    .style("font-weight", "bold")
    .style("font-family", "Raleway")
    .html("<div id='notmuchlots_"+i+"' style='margin-left: 5px; margin-top: -4px'>"
      +"Not&nbspmuch"
      +"<span id='notmuchSpan_"+i+"' style='margin-left: "+137+"px'></span>"
      +"Lots</div>"
      // subskill sliders button
      // "<div id=subSliderDiv_"+i+">"+
      // "<span>"+
      //   "<button id='btnSubsliders_"+i+"' class='expand-sliders-btn' style='width: 250px; margin-top: 10px; margin-left: 1px; fill: white; z-index: 99;' "+
      //   "onclick='expandSliders("+i+")' type='button'>"+
      //     "<span id='spanSubsliders_"+i+"' style='font-family: Raleway; font-size: 15; font-weight: bold; color: #49AC52;'>"+sliderButtonArrows[i]+" view "+sliderTitlesArrayMain[i].toLowerCase()+" "+sliderButtonArrows[i]+"</span>"+
      //   "</button>"+
      // "</span></div>"
      )
    .select(function() {
    return this.parentNode;
    })
  // Slider svg
  .append("svg")
    .style("z-index", 99)
    // .attr("viewBox", "0 3 "+230+" "+50)
    .style("position", "absolute")
    .style("top", 32+"px") // y position
    // .style("margin-left", -sub_xtranslate+"%") // x position
    .attr("id", "slider_"+i)
    .attr("width", 250)
    .attr("height", 50);


  sliderSVGArray[i].attr("class", "d-inline d-sm-inline d-md-inline d-lg-inline d-xl-inline")
  var mainSlidersWidth = 223;
  var reductionFactor = 0.7;

  // Scale
  // sliderScaleArray[i] = d3.scaleLinear()
  //   .domain([0, d3.max(nodes, function(d){ return d[sliderArrayMain[i]]}) * reductionFactor ]) // lower the maximum for all skills by 20% to prevent filtering down to 0
  //   .range([0, mainSlidersWidth]) // Width of slider is 200 px
  //   .clamp(true);

  // Bugfix: math max not working
  if(["Math and Spatial skills"].includes(sliderTitlesArray[i])) {
  sliderScaleArray[i] = d3.scaleLinear()
    .domain([0, 59 * reductionFactor])
    .range([0, mainSlidersWidth]) // Width of slider is 200 px
    .clamp(true);
  }

  // Move Wage, Number of Jobs down
    // Slider
  sliderMulti[i] = sliderSVGArray[i].append("g") // switch to SVG with viewBox?
  .attr("class", "slider")
  .attr("transform", "translate(" + 32 + "," + 25 + ")");

  // track
  sliderMulti[i].append("line")
  .attr("class", "track")
  .attr("x1", sliderScaleArray[i].range()[0])
  .attr("x2", sliderScaleArray[i].range()[1])
  .select(function() {
    return this.parentNode;
  }) // inset
  .append("line")
  .attr("x1", sliderScaleArray[i].range()[0])
  .attr("x2", sliderScaleArray[i].range()[1])
  .attr("class", "track-inset")
  .select(function() {
    return this.parentNode;
  }) // inset-left (fills up green on drag)
  .append("line")
  .attr("x1", sliderScaleArray[i].range()[0])
  .attr("x2", sliderScaleArray[i].range()[0])
  .attr("class", "track-inset-left")
  .attr("id","inset-left_"+i)
  .select(function() {
    return this.parentNode;
  }) // overlay
  .append("line")
  .attr("x1", sliderScaleArray[i].range()[0])
  .attr("x2", sliderScaleArray[i].range()[1])
  .attr("class", "track-overlay")
  .attr("id", i)
  .on("mouseover", function() {
    d3.select("#handle_"+this.id).style("fill","#eaeaea")
  })
  .on("mouseout", function() {
    d3.select("#handle_"+this.id).style("fill","white")
    if(typeof miniTooltip != "undefined"){
      miniTooltip.transition().duration(500)
      .style("opacity",0)
    }
  })
  .call(d3.drag()
    .on("start.interrupt", function() {
      sliderMulti[event.target.id].interrupt();
    }) // drag update function
    .on("start drag", function() {
      if(typeof miniTooltip == "undefined"){
        miniTooltip = d3.select("body").append("div")
          .attr("class", "minitooltip")
          .style("opacity", 0);
      }
      // show mini tooltip indicating how many job groups remain
      


      miniTooltip.transition().duration(200)
      .style("opacity",.9)
      miniTooltip.html(graph.length + " job groups<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remain")
      // .style("left", (event.pageX - 64) + "px")
      
      if($(event.target).attr('class') == 'track-overlay'){
        miniTooltip.style("top", (event.target.getBoundingClientRect().top - 90) + "px")
      }
                  // (d3.select("#handle_"+this.id)
      if(graph.length >= 10){ 
        miniTooltip.style("left", (document.getElementById("handle_"+this.id).getBoundingClientRect().left - 55) + "px") 

      }
      graph.length <= 50 ? miniTooltip.style("color","#FEB22E") : miniTooltip.style("color", "white")
      if(graph.length <= 25){ 
        miniTooltip.style("color","#FE2E2E") 





        expandCircleImages()









      } else { collapseCircleImages(); }

      if(graph.length >= 175){
        forceGravity = d3.forceManyBody().strength(function(d) { return -10 * d.radius });

        simulation
        .force("collide", d3.forceCollide(function(d) { return d.radius }))
        .force("cluster", forceCluster)
        .force("gravity", forceGravity)
        .force("x", forceXCombine)
        .force("y", forceYCombine)
        .on("tick", tick);

        if(graphMode == 0){
          simulation.alpha(0.15).alphaTarget(0.001).restart();
        }

      }

      updateMulti(sliderScaleArray[event.target.id].invert(d3.event.x), currentMode); // pass the current line id to update function
      // }
    
    })
  );

  handleArray[i] = sliderMulti[i].insert("circle", ".track-overlay")
    .attr("class", "handleTutorial")
    .style("z-index", 99)
    .attr("r", 9)
    .attr("id","handle_"+i);

    // Bugfix: lang slider not on top
  // if(["Language Skills"].includes(sliderTitlesArray[i])) {
  //   d3.select("#"+i).style("z-index", 99);
  // }

    }
};


function collapseCircleImages() {

  if(circlesExpanded == 1){
    circlesExpanded = 0;

    circles.transition().duration(700)
    .delay(function(d, i) { return i * 5})
    .attrTween("r", function(d) {
      var i = d3.interpolate(40, 10);
      return function(t) { return d.radius = i(t); };
    }) 

    if(graphMode == 0) {
      setTimeout(function() { 
          simulation
          .force("collide", d3.forceCollide(function(d) { return d.radius + nodePadding }))
          .force("cluster", forceCluster)
          // .force("gravity", forceGravity)
          .force("x", forceXCombine)
          .force("y", forceYCombine)
          .on("tick", tick);

          simulation.alpha(0.15).alphaTarget(0.001).restart();

      }, 0);
      // setTimeout(function() { resetSimulation() }, 700);

      // setTimeout(function() { enterUpdateCircles();
        
        forceGravity = d3.forceManyBody().strength(function(d) { return -22 * d.radius });

        simulation
        .force("gravity", // default strength = -30, negative strength = repel, positive = attract
                forceGravity)
        // collapse gravity 
        .force("collide", d3.forceCollide(function(d) { return d.radius + 20 }))
        .alpha(0.6).alphaTarget(0.001).restart(); 
    }
  }
}

function expandCircleImages() {

  //bookmark
  //modify: toggle-on, toggle-off, shrink back down
  if (circlesExpanded == 0) {
        
        circlesExpanded = 1;

        circles.transition().duration(500)
          .delay(function(d, i) { return i * 5})
          .attrTween("r", function(d) {
            var i = d3.interpolate(10, 40);
            return function(t) { return d.radius = i(t); };
          })
          // transition the job images into the fill pattern

            circles.style("fill", function(d) { 
              circleExpanded[d.id] = 1;
              return "url(#pattern_"+d.id+")" })
              .style("stroke-width","2px")
              .style("stroke", function(d) { return color(d.cluster)})



          // .attr("fill", function(d) { return "url(#pattern_"+d.id+")" })

        if(graphMode == 0) {
          setTimeout(function() { 
            forceGravity = d3.forceManyBody().strength(function(d) { return -30 * d.radius });

              simulation
              .force("collide", d3.forceCollide(function(d) { return 42 }))
              .force("cluster", forceCluster)
              .force("gravity", forceGravity)
              .force("x", forceXCombine)
              .force("y", forceYCombine)
              .on("tick", tick);

              simulation.alpha(0.15).alphaTarget(0.001).restart();

          }, 500);
          // setTimeout(function() { resetSimulation() }, 700);

          // setTimeout(function() { enterUpdateCircles();
            
            // .force("collide", d3.forceCollide(function(d) { return d.radius + 20 }))
            // .alpha(0.6).alphaTarget(0.001).restart(); 
          // }, 200);
        }
      } else if (circlesExpanded == 1) {

      }

      setTimeout(function(){d3.select("#nextLink").style("pointer-events","auto").attr("href","Pave.html").transition().duration(500).style("opacity",1)})


}

















function smashTogether(force, temp) {
  simulation
  .force("x", d3.forceX().strength(force)).alpha(temp)
  .force("y", d3.forceY().strength(force)).alpha(temp)
  .alphaTarget(0.001)
  .restart()
}

// TODO: maxWorkers, maxSalary, skillsMath not working
var minWorkers = d3.min(nodes, function(d) {return d.workers}),
minWage = d3.min(nodes, function(d) {return d.salaryMed});


maxYearsStudy = d3.max(nodes, function(d) {return d.yearsStudy}); // 5




///////////// Reset Filters /////////////

d3.select("#resetFilters").on('click', function(d) {
  // if (graphMode == 1) {
  //   graphMode = 0;

  //   graphModeOff();
  // }c
  resetFilters(currentMode);
});

resetFilters = function(mode) {
//collapseCircleImages()
  if(circlesExpanded == 1){
    circlesExpanded = 0;

    circles.transition().duration(350)
    // .delay(function(d, i) { return i * 5})
    .attrTween("r", function(d) {
      var i = d3.interpolate(40, 10);
      return function(t) { return d.radius = i(t); };
    }) 

    if(graphMode == 0) {
      setTimeout(function() { 
          
          forceGravity = d3.forceManyBody().strength(function(d) { return -10 * d.radius });

          simulation
          .force("cluster", forceCluster)
          // .force("gravity", forceGravity)
          .force("x", forceXCombine)
          .force("y", forceYCombine)
          .on("tick", tick)
          .force("gravity", // default strength = -30, negative strength = repel, positive = attract
                  forceGravity)
          // .force()
          .force("collide", d3.forceCollide(function(d) { return d.radius + nodePadding }))

          simulation.alpha(0.6).alphaTarget(0.001).restart(); 

      }, 450);
    }
  }//end collapseCircleImages
  // Reset green inset-left on all sliders
  // Main sliders
  for(var i=0; i<sliderArray.length; i++) {

      d3.select("#inset-left_"+i).transition().duration(500).attr("x2", 0 )

  };

  // reset the graph
  graph = store;
  hideAll();
  hideGraphViewCallout();
  // reset the slider positions
  for(var i=0; i<sliderArray.length; i++) {
    handleArray[i].transition().duration(500).attr("cx", sliderScaleArray[i](0)); // move the slider handle
    sliderPositionsArray[i] = 0; // Update the slider positions array
  };

  // reset all circles
  circles = circles.data(store, function(d) { return d.id });
  // ENTER (create the circles with all attributes)
  enterUpdateCircles();
  // restart simulation only if graph mode off
  if (graphMode == 0) {
      resetSimulation();

      // forceGravity = d3.forceManyBody().strength(function(d) { return -10 * d.radius });

      // simulation
      // .force("collide", d3.forceCollide(function(d) { return d.radius }))
      // .force("cluster", forceCluster)
      // .force("gravity", forceGravity)
      // .force("x", forceXCombine)
      // .force("y", forceYCombine)
      // .on("tick", tick);

      // if(graphMode == 0){
      //   simulation.alpha(0.15).alphaTarget(0.001).restart();
      // }

  }
///////////// Reset Filters /////////////

d3.select("#resetFilters").on('click', function(d) {
  // if (graphMode == 1) {
  //   graphMode = 0;

  //   graphModeOff();
  // }c
  resetFilters(currentMode);
});

resetFilters = function(mode) {
//collapseCircleImages()
  if(circlesExpanded == 1){
    circlesExpanded = 0;

    circles.transition().duration(350)
    // .delay(function(d, i) { return i * 5})
    .attrTween("r", function(d) {
      var i = d3.interpolate(40, 10);
      return function(t) { return d.radius = i(t); };
    }) 

    if(graphMode == 0) {
      setTimeout(function() { 
          
          forceGravity = d3.forceManyBody().strength(function(d) { return -10 * d.radius });

          simulation
          .force("cluster", forceCluster)
          // .force("gravity", forceGravity)
          .force("x", forceXCombine)
          .force("y", forceYCombine)
          .on("tick", tick)
          .force("gravity", // default strength = -30, negative strength = repel, positive = attract
                  forceGravity)
          // .force()
          .force("collide", d3.forceCollide(function(d) { return d.radius + nodePadding }))

          simulation.alpha(0.6).alphaTarget(0.001).restart(); 

      }, 450);
    }
  }//end collapseCircleImages
  // Reset green inset-left on all sliders
  // Main sliders
  for(var i=0; i<sliderArray.length; i++) {

      d3.select("#inset-left_"+i).transition().duration(500).attr("x2", 0 )

  };

  // reset the graph
  graph = store;
  hideAll();
  hideGraphViewCallout();
  // reset the slider positions
  for(var i=0; i<sliderArray.length; i++) {
    handleArray[i].transition().duration(500).attr("cx", sliderScaleArray[i](0)); // move the slider handle
    sliderPositionsArray[i] = 0; // Update the slider positions array
  };

  // reset all circles
  circles = circles.data(store, function(d) { return d.id });
  // ENTER (create the circles with all attributes)
  enterUpdateCircles();
  // restart simulation only if graph mode off
  resetSimulation();
 }


function resetSimulation() {
  simulation.nodes(store)
  .force("collide", forceCollide)
  .force("cluster", forceCluster)
  .force("gravity", forceGravity)
  .force("x", forceXCombine)
  .force("y", forceYCombine)
  .on("tick", tick);

  restartSimulation();
}

function restartSimulation(){
  simulation.alpha(0.25).alphaTarget(0.001).restart();
}


///// Tooltips (post-filter)

enterUpdateCircles = function() {
    var newCircles = circles.enter().append("circle")
    .attr("r", function(d) { return d.radius }) // start at full radius
    .attr("transform", "translate("+window.innerWidth*0.5+","+ (120 + window.innerHeight*0.2) +")") //flag! need to make equation for width/height ratio
    .style("fill", function(d) { 
      if(circleExpanded[d.id] != 1){
        return color(d.cluster); 
      }else { return "url(#pattern_"+d.id+")" }
     })
    .attr("class","jobCircle")
    .attr("id",function(d) { return "circle_"+d.id })
    .attr("opacity",
      function(d) { // make filtered circles transparent
        // if the industry is on the list, transparent
        if( filteredIndustries.includes(+d.industryNum) ) { 
          return 0.1 }
        else{ 
          return 1 }
    })  


    // newCircles.attr("r",0).transition().duration(500).attr("r", function(d) { return d.radius })

    // Tooltips
 // Tooltips
    .on("mouseenter", function(d) {
      if (clicked == 1) return;
      // highlight the current circle
      d3.selectAll("circle").attr("stroke", "none");
      d3.select(this)
        .style("fill", "url(#pattern_"+d.id+")" )
        // .attr("stroke", "black")
        .style("stroke-width", 2)
        .attr("stroke", color(d.cluster));
      showToolTip(0);
      tooltipMouseover(d);
      // hoverTimeout = setTimeout(function(){
      //   tooltipLarge(d)
      //   clicked = 1
      // }, 1750)
      })
    .on("mouseout", function(d) {

      if(!circleExpanded[d.id] == 1){
        d3.select(this)
          .style("fill", color(d.cluster) )
          // .attr("stroke", "black")
          .style("stroke-width", 2)
          .attr("stroke", color(d.cluster));
      }

      // clearTimeout(hoverTimeout)
      if (clicked == 1) return;
      clicked = 0;
      hideToolTip(500)
      d3.select(this).attr("stroke", "none");
      // div.transition().duration(500).style("opacity", 0)

    })
    .on("click", function(d) {
      // clearTimeout(hoverTimeout)
      // click-off
      if (clicked == 1) { 
        clicked = 0
        hideToolTip(500)
      // click-on
      } else if (clicked == 0) {
        clicked = 1;
        tooltipLarge(d);
       }
      // hideToolTip(0);
      // if(typeof div2 != "undefined") div2.transition().duration(250).style("height","0px").remove();
      // tooltipSmall(d);}
      })

  // drag_handler(newCircles);
  // //  ENTER + UPDATE
  // if(graphMode == 1){ // transition in radii in graph mode
  //   circles = circles.merge(newCircles.attr("r",0).transition().duration(500).attr("r", function(d) { return d.radius }));
  // }else if(graphMode == 0){
  //   circles = circles.merge(newCircles);
  // }
  

} }


// Update function which detects current slider
//  general update pattern for updating the graph
function updateMulti(h, mode) {
 
  // using the slider handle
  var sliderID = event.target.id;
  // jam sliders at n <= 10
    // jamSliders()
    handleArray[sliderID].attr("cx", sliderScaleArray[sliderID](h)); // move the slider handle
  // }

  // Update the slider positions array
  sliderPositionsArray[sliderID] = sliderScaleArray[event.target.id].invert(d3.event.x);

  
  var filteredNodes = filterAll()
  //  UPDATE
  circles = circles.data(filteredNodes, function(d) { return d.id });
    
  // EXIT
  circles.exit().transition().duration(500)
  // exit transition: "pop" radius * 1.5 + 5 & fade out
  .attr("r", function(d) { return d.radius * 2.1 + 5 })
  .styleTween("opacity", function(d) {
    var i = d3.interpolate(1, 0);
    return function(t) { return i(t); };
  })
  .remove();

  // ENTER (create the circles with all attributes)
  enterUpdateCircles();

  //bookmarklet : resetSimulation()?

  // reset simulation if graph mode = off
    simulation.nodes(filteredNodes)
    .force("collide", forceCollide)
    .force("cluster", forceCluster)
    .force("gravity", forceGravity)
    .force("x", forceXCombine)
    .force("y", forceYCombine)
    .on("tick", tick);
    restartSimulation();

// } // end if graph length > 10
};//end updateMulti


//////////////// Filter Functions 3: filter on all variables at once //////////////////////


filterAll = function() {
  
  // first, clear the list
  var listToDeleteMulti = [];
  
  // reset the graph
  graph = [];

  // var currentSlider = sliderPositionsArray[event.target.id]

  store.forEach(function(d){ // for each circle

    // put you on the list if the slider position is above your value:
    
    // for current slider only
    for(var s in sliderPositionsArray){        
      // if the slider position is above your value  &  if you're not already on the list
      if(d[sliderArray[s]] < sliderPositionsArray[s] && !listToDeleteMulti.includes(d[sliderArray[s]])) {
        // put you on the list
        listToDeleteMulti.push(d.id);
      }
    }

  })
  
  // update the graph based on the filter list
  store.forEach(function(n) {
    // if you're not on the filter list
    if (!listToDeleteMulti.includes(n.id)) {
      // put you on the graph         (start graph empty? or check)
      graph.push(n);
    // if you're on the list
    } else if (listToDeleteMulti.includes(n.id)) {
      // for each graph item
      graph.forEach(function(d, p) { // p = position
        if (n.id === d.id) {
          graph.splice(p, 1); // get you off of there!
        }

      })
    };
  });

  // Main sliders
  for(var i=2; i<3; i++) {

    // if(event.target.id != i) {
    //   // find the minimum of each slider on the current graphed set
    //   var thisMinimum = d3.min(graph, function(d){ return sliderScaleArray[2](d[sliderArrayMain[i]]) })
    //   // move the slider handle
    //   handleArray[i].attr("cx", thisMinimum);
    //   // fill the left side green
    //   d3.select("#inset-left_2").attr("x2", thisMinimum )

    // }else if(event.target.id == i) {
      var thisMinimum = d3.min(graph, function(d){ return sliderScaleArray[2](d[sliderArrayMain[i]]) })
      // fill the left side green (using mouse position on current slider)

      d3.select("#inset-left_"+i).attr("x2", function() {
        if (sliderScaleArray[2].invert(d3.event.x) <= 0) { return sliderScaleArray[2](sliderPositionsArray[2]) }
        else { 
          return d3.event.x }
        } )
    // }
  };

  // Subskill sliders
  // for(var i=4; i<sliderArray.length; i++) {
  //   if(event.target.id != i) {
  //     var thisMinimum = d3.min(graph, function(d){ return sliderScaleArray[i](d[sliderArray[i]]) })
  //     handleArray[i].attr("cx", thisMinimum); // move the slider handle
  //     // fill the left side green
  //     d3.select("#inset-left_"+i).attr("x2", thisMinimum )

  //   }else if(event.target.id == i) {
  //     var thisMinimum = d3.min(graph, function(d){ return sliderScaleArray[i](d[sliderArray[i]]) })
  //     // fill the left side green (using mouse position on current slider)
  //     d3.select("#inset-left_"+i).attr("x2", d3.event.x )
  //   }
  // };
  // calloutCheck()
  return graph;
} // end filterAll
}// Update function which detects current slider


})
} // end of d3.csv




</script>

<svg style="pointer-events: none;">
  <defs>

    <filter id="dropshadow" width="200%" height="200%">
      <feGaussianBlur in="SourceAlpha" stdDeviation="2.5"/> <!-- stdDeviation is how much to blur -->
      <feOffset dx="1.05" dy="1.4" result="offsetblur"/> <!-- how much to offset -->
      <feComponentTransfer>
        <feFuncA type="linear" slope="0.35"/> <!-- slope is the opacity of the shadow -->
      </feComponentTransfer>
      <feMerge> 
        <feMergeNode/> <!-- this contains the offset blurred image -->
        <feMergeNode in="SourceGraphic"/> <!-- this contains the element that the filter is applied to -->
      </feMerge>
    </filter>

    <filter id="f1" width="150%" height="150%">
      <feGaussianBlur result="blurOut" in="SourceAlpha" stdDeviation="1.5" />
      <feOffset result="offsetBlur" in="blurOut" dx="1.25" dy="2" />
      <feComponentTransfer>
        <feFuncA type="linear" slope="0.4"/> <!-- slope is the opacity of the shadow -->
      </feComponentTransfer>
      <feMerge> 
        <feMergeNode/> <!-- this contains the offset blurred image -->
        <feMergeNode in="SourceGraphic"/> <!-- this contains the element that the filter is applied to -->
      </feMerge>
    </filter>

    <filter id="f2" width="150%" height="150%">
      <feGaussianBlur result="blurOut" in="SourceAlpha" stdDeviation="5.5" />
      <feOffset result="offsetBlur" in="blurOut" dx="2" dy="5" />
      <feComponentTransfer>
        <feFuncA type="linear" slope="0.6"/> <!-- slope is the opacity of the shadow -->
      </feComponentTransfer>
      <feMerge> 
        <feMergeNode/> <!-- this contains the offset blurred image -->
        <feMergeNode in="SourceGraphic"/> <!-- this contains the element that the filter is applied to -->
      </feMerge>
    </filter>
  </defs>
</svg>

</body>

</html>  		

